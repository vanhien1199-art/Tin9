<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tr·ª£ l√Ω Scratch - H·ªèi ƒë√°p</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root{
            --primary: #1479ff;
            --accent: #ffa940;
            --bg-start: #f4f7fc;
            --bg-end: #e6f0ff;
            --card: #ffffff;
            --text: #14182a;
            --muted: #6d758c;
            --radius: 16px;
            --shadow-1: 0 6px 24px rgba(20,121,255,0.08);
        }
        html,body{ height:100%; margin:0; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(135deg, var(--bg-start), var(--bg-end)); color:var(--text); }
        .container{ max-width:980px; margin:20px auto 80px; padding:0 18px; }
        header{ background: linear-gradient(90deg, var(--primary), #64b5f6 90%); color:#fff; padding:18px 14px; text-align:center; border-bottom-left-radius:20px; border-bottom-right-radius:20px; box-shadow: var(--shadow-1); position:relative; }
        .home-btn{ position:absolute; left:12px; top:12px; font-size:1.5rem; color:#fff; text-decoration:none; opacity:0.95; }
        header h1{ margin:0; font-size:1.2rem; font-weight:700; }
        .card{ background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(250,252,255,0.98)); border-radius:var(--radius); box-shadow: var(--shadow-1); padding:14px; margin-top:16px; display:flex; flex-direction:column; gap:10px; }
        .chat-header-row{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
        #ai-chatbot-card h2{ font-size:1.05rem; margin:0; display:flex; align-items:center; gap:10px; }
        #ai-chatbot-card p{ margin:6px 0 0; color:var(--muted); font-size:0.95rem; }
        .chat-controls{ display:flex; gap:8px; align-items:center; }
        .icon-btn{ background:transparent; border: none; cursor:pointer; padding:8px; border-radius:10px; color:var(--primary); font-size:1rem; }
        .chat-window{ flex:1 1 auto; min-height:300px; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; overflow-y:auto; -webkit-overflow-scrolling: touch; border:1px solid rgba(16,24,64,0.06); background: linear-gradient(180deg, rgba(249,252,255,0.9), rgba(245,248,255,0.92)); }
        .chat-message{ max-width:82%; padding:10px 14px; border-radius:18px; font-size:0.98rem; line-height:1.45; word-break:break-word; white-space:pre-wrap; box-shadow: 0 2px 10px rgba(16,24,64,0.03); }
        .ai-message{ align-self:flex-start; background: linear-gradient(180deg, #f6f8ff, #eef3ff); color:var(--text); border-bottom-left-radius:8px; border-top-right-radius:8px; }
        .user-message{ align-self:flex-end; background: linear-gradient(90deg, var(--primary) 0%, #1a1a1a 100%); color:#fff; border-bottom-right-radius:8px; border-top-left-radius:8px; }
        .chat-input-area{ display:flex; gap:10px; align-items:center; margin-top:6px; }
        .chat-input-area input[type="text"]{ flex:1; padding:12px 14px; border-radius:24px; border:1px solid #e4e9f5; font-size:1rem; background:#fff; outline:none; }
        .chat-input-area input[type="text"]:focus{ box-shadow:0 6px 22px rgba(20,121,255,0.06); border-color:var(--primary); }
        .chat-input-area button.send-btn{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:20px; cursor:pointer; font-weight:600; }
        .attachment-preview{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .attachment-item{ background:rgba(16,24,64,0.04); border-radius:10px; padding:6px; display:flex; gap:8px; align-items:center; max-width:70%; }
        .attachment-thumb{ width:56px; height:40px; object-fit:cover; border-radius:6px; background:#fff; border:1px solid rgba(16,24,64,0.06); }
        .attachment-meta{ display:flex; flex-direction:column; gap:4px; font-size:0.85rem; color:var(--muted); max-width:calc(100% - 64px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .attachment-remove{ background:transparent; border:none; color:#ff6b6b; cursor:pointer; font-size:1.05rem; padding:4px; margin-left:6px; }
        #ai-chatbot-card.chat-fullscreen{ position:fixed; inset:0; width:100vw; height:100vh; margin:0; border-radius:0; z-index:9999; padding:18px; background: linear-gradient(180deg, #fff, #f6fbff); }
        #ai-chatbot-card.chat-fullscreen .chat-window{ height: calc(100vh - 200px); min-height: 380px; }
        .site-footer{ background: linear-gradient(90deg, #232d46, #334877 90%); color:#e7eaf1; padding:12px 0; font-size:0.92rem; }
        .footer-inner{ max-width:900px; margin:0 auto; padding:8px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .footer-contact a{ color:#ffd9a6; text-decoration:none; font-weight:600; }
        .footer-note{ color:#c7cbe0; font-size:0.86rem; }
        @media (max-width:700px){ .container{ padding:0 12px 90px; margin-top:10px; } header{ padding:12px; } header h1{ font-size:1.05rem; } .card{ padding:12px; border-radius:14px; } .chat-window{ min-height: 260px; padding:10px; } #ai-chatbot-card.chat-fullscreen .chat-window{ height: calc(100vh - 170px); } }
        @media (max-width:420px){ .chat-window{ min-height:220px; } .chat-input-area button{ padding:9px 12px; font-size:0.95rem; } .footer-inner{ flex-direction:column; align-items:center; gap:6px; text-align:center; padding:10px 12px; } }
    </style>
</head>
<body id="page-top">
    <header>
        <a href="/" class="home-btn" title="V·ªÅ trang ch·ªß">üè†</a>
        <h1>Tr·ª£ l√Ω H·ªçc Scratch</h1>
    </header>

    <div class="container">
        <section id="ai-chatbot-card" class="card" aria-label="Tr·ª£ l√Ω Scratch chat">
            <div class="chat-header-row">
                <h2>
                    <span style="display:inline-flex;align-items:center;">
                        <svg width="34" height="34" viewBox="0 0 48 48" fill="none" style="margin-right:8px;vertical-align:middle;">
                          <rect x="8" y="14" width="32" height="24" rx="12" fill="#1479ff"/><rect x="16" y="22" width="16" height="8" rx="4" fill="#fff"/><circle cx="18" cy="26" r="2" fill="#1479ff"/><circle cx="30" cy="26" r="2" fill="#1479ff"/><rect x="21" y="8" width="6" height="6" rx="3" fill="#ffa940"/><rect x="29" y="8" width="6" height="6" rx="3" fill="#ffa940"/>
                        </svg>
                        Tr·ª£ l√Ω Scratch
                    </span>
                </h2>
                <div class="chat-controls" role="toolbar" aria-label="Chat controls">
                    <button id="toggle-fullscreen-btn" class="icon-btn" title="To√†n m√†n h√¨nh" aria-pressed="false">‚§¢</button>
                    <button id="close-fullscreen-btn" class="icon-btn" title="ƒê√≥ng to√†n m√†n h√¨nh" aria-pressed="false" style="display:none">‚úï</button>
                </div>
            </div>
            <p>Xin ch√†o! M√¨nh l√† Mentor Scratch ‚Äî h·ªèi g√¨ c·ª© h·ªèi nh√©.</p>
            <div id="chat-window" class="chat-window" aria-live="polite">
                <div class="chat-message ai-message">Hi! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</div>
            </div>
            
            <div id="attachment-preview" class="attachment-preview" aria-hidden="true" style="display:none"></div>

            <div class="chat-input-area" role="form" aria-label="G·ª≠i tin nh·∫Øn">
                <label for="file-input" class="icon-btn" title="ƒê√≠nh k√®m t·ªáp">üìé</label>
                <input type="file" id="file-input" accept="image/*" multiple style="display:none" aria-label="Ch·ªçn t·ªáp ƒë√≠nh k√®m" capture="environment">
                <input type="text" id="user-input" placeholder="ƒê·∫∑t c√¢u h·ªèi b·∫•t k·ª≥..." autocomplete="off" aria-label="N·ªôi dung c√¢u h·ªèi">
                <button id="send-button" class="send-btn">G·ª≠i</button>
            </div>
        </section>
    </div>

    <footer class="site-footer" aria-hidden="false">
        <div class="footer-inner">
            <div class="footer-contact">
                <span class="footer-note">Li√™n h·ªá: </span>
                <li>Facebook: <a href="https://www.facebook.com/nung.hien" target="\_blank">https://www.facebook.com/nung.hien</a></li>
            </div>
            <div class="footer-note">¬© 2025 Mentor Scratch ‚Äî Website h·ªó tr·ª£ h·ªçc t·∫≠p phi l·ª£i nhu·∫≠n. Made with ‚ù§Ô∏è by Nung Van Hien.</div>
        </div>
    </footer>

    <a href="#page-top" id="back-to-top-btn" title="L√™n ƒë·∫ßu trang" style="display:none;">‚¨ÜÔ∏è</a>

    <script>
    // To√†n b·ªô logic c·ªßa Chatbot, bao g·ªìm UI, X·ª≠ l√Ω t·ªáp, v√† G·ª≠i tin nh·∫Øn
    // File chatbot.js kh√¥ng c√≤n c·∫ßn thi·∫øt
    document.addEventListener('DOMContentLoaded', function() {
        const backToTopBtn = document.getElementById("back-to-top-btn");
        window.onscroll = () => {
            backToTopBtn.style.display = (document.body.scrollTop > 140 || document.documentElement.scrollTop > 140) ? "block" : "none";
        };

        // === KHAI B√ÅO BI·∫æN GIAO DI·ªÜN ===
        const chatCard = document.getElementById('ai-chatbot-card');
        const toggleBtn = document.getElementById('toggle-fullscreen-btn');
        const closeBtn = document.getElementById('close-fullscreen-btn');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');
        const previewArea = document.getElementById('attachment-preview');

        // === LOGIC TO√ÄN M√ÄN H√åNH ===
        function openFullscreenMode() {
            chatCard.classList.add('chat-fullscreen');
            toggleBtn.style.display = 'none';
            closeBtn.style.display = 'inline-block';
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            userInput.focus();
        }
        function closeFullscreenMode() {
            chatCard.classList.remove('chat-fullscreen');
            toggleBtn.style.display = 'inline-block';
            closeBtn.style.display = 'none';
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
        }
        toggleBtn.addEventListener('click', openFullscreenMode);
        closeBtn.addEventListener('click', closeFullscreenMode);

        // === LOGIC T·ª∞ CU·ªòN ===
        const observer = new MutationObserver(() => {
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        });
        observer.observe(chatWindow, { childList:true, subtree:true });

        // === LOGIC X·ª¨ L√ù T·ªÜP ƒê√çNH K√àM (UI) ===
        // Bi·∫øn 'attachments' n√†y ƒë∆∞·ª£c gi·ªØ l·∫°i t·ª´ file g·ªëc c·ªßa b·∫°n
        let attachments = []; 

        // H√†m renderAttachments t·ª´ file g·ªëc c·ªßa b·∫°n
        function renderAttachments() {
            previewArea.innerHTML = '';
            if (attachments.length === 0) {
                previewArea.style.display = 'none';
                return;
            }
            previewArea.style.display = 'flex';

            attachments.forEach(att => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.setAttribute('data-id', att.id);

                if (att.file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'attachment-thumb';
                    img.src = att.url;
                    item.appendChild(img);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'attachment-thumb';
                    placeholder.textContent = 'üìÑ';
                    item.appendChild(placeholder);
                }

                const meta = document.createElement('div');
                meta.className = 'attachment-meta';
                meta.textContent = att.file.name;
                item.appendChild(meta);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'attachment-remove';
                removeBtn.innerHTML = '‚úï';
                removeBtn.addEventListener('click', () => {
                    removeAttachment(att.id);
                });
                item.appendChild(removeBtn);
                previewArea.appendChild(item);
            });
        }
        
        // H√†m removeAttachment t·ª´ file g·ªëc c·ªßa b·∫°n
        function removeAttachment(id) {
            const idx = attachments.findIndex(a => a.id === id);
            if (idx !== -1) {
                URL.revokeObjectURL(attachments[idx].url);
                attachments.splice(idx,1);
                renderAttachments();
            }
        }

        // H√†m addFiles t·ª´ file g·ªëc c·ªßa b·∫°n
        function addFiles(fileList) {
            for (let i=0; i < fileList.length; i++) {
                const f = fileList[i];
                if (!f.type.startsWith('image/')) {
                    alert('L·ªói: Ch·ªâ h·ªó tr·ª£ t·ªáp h√¨nh ·∫£nh.');
                    continue;
                }
                const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                const att = { id, file: f, url: URL.createObjectURL(f) };
                attachments.push(att);
            }
            renderAttachments();
        }

        fileInput.addEventListener('change', (e) => {
            if (e.target.files) addFiles(e.target.files);
            fileInput.value = ''; // Reset
        });

        // === LOGIC G·ªåI AI (M·ªöI - THAY TH·∫æ chatbot.js) ===

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        function appendMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${sender}-message`;
            if (sender === 'ai') {
                msgDiv.innerHTML = marked.parse(message);
            } else {
                msgDiv.innerText = message;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            return msgDiv;
        }

        async function handleSend() {
            const textValue = userInput.value.trim();
            const currentAttachments = [...attachments]; 

            if (!textValue && currentAttachments.length === 0) return;
            
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            attachments.length = 0; 
            renderAttachments(); 

            let userMessageContent = textValue;
            if (currentAttachments.length > 0) {
                 userMessageContent += `\n(ƒê√£ ƒë√≠nh k√®m ${currentAttachments.length} ·∫£nh)`;
            }
            appendMessage(userMessageContent, 'user');
            
            const loadingMsg = appendMessage('Mentor Scratch ƒëang suy nghƒ©... ü§ñ', 'ai');

            const payload = {
                question: textValue,
                lesson_id: 'default',
                attachments: [] 
            };

            try {
                for (const att of currentAttachments) {
                    const base64Data = await fileToBase64(att.file);
                    payload.attachments.push({
                        mimeType: att.file.type,
                        base64Data: base64Data
                    });
                    URL.revokeObjectURL(att.url);
                }

                // ƒê∆Ø·ªúNG D·∫™N QUAN TR·ªåNG
                // N√≥ tr·ªè v·ªÅ g·ªëc, Cloudflare s·∫Ω √°nh x·∫° n√≥ t·ªõi /scratch3/functions/askAI
                // n·∫øu ch√∫ng ta c·∫•u h√¨nh Root Directory ƒë√∫ng
                const response = await fetch('/functions/askAI', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errData = JSON.parse(errorText);
                        errorMessage = errData.error || `L·ªói ${response.status}: ${errorText}`;
                    } catch (e) {
                        errorMessage = `L·ªói ${response.status} t·ª´ m√°y ch·ªß: ${errorText.substring(0, 300)}...`; 
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                loadingMsg.innerHTML = marked.parse(data.answer);

            } catch (error) {
                console.error('L·ªói khi g·ªçi AI:', error);
                loadingMsg.innerHTML = `<strong>R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra:</strong><br>${error.message}`;
                loadingMsg.style.color = 'red';
                loadingMsg.style.whiteSpace = 'normal';
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // === G√ÅN S·ª∞ KI·ªÜN G·ª¨I (M·ªöI) ===
        sendBtn.addEventListener('click', handleSend);
        
        userInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                sendBtn.click(); // K√≠ch ho·∫°t h√†m handleSend
            }
        });

    }); // K·∫øt th√∫c DOMContentLoaded
    </script>

    </body>
</html>
