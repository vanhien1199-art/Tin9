<!DOCTYPE html>
<html lang="vi">
<body id="page-top">
    <header>
        <a href="/" class="home-btn" title="V·ªÅ trang ch·ªß">üè†</a>
        <h1>Tr·ª£ l√Ω H·ªçc Scratch</h1>
    </header>

    <div class="container">
        <section id="ai-chatbot-card" class="card" aria-label="Tr·ª£ l√Ω Scratch chat">
            <div class="chat-header-row">
                <h2>
                    <span style="display:inline-flex;align-items:center;">
                        <svg width="34" height="34" viewBox="0 0 48 48" fill="none" style="margin-right:8px;vertical-align:middle;">
                          <rect x="8" y="14" width="32" height="24" rx="12" fill="#1479ff"/>
                          <rect x="16" y="22" width="16" height="8" rx="4" fill="#fff"/>
                          <circle cx="18" cy="26" r="2" fill="#1479ff"/>
                          <circle cx="30" cy="26" r="2" fill="#1479ff"/>
                          <rect x="21" y="8" width="6" height="6" rx="3" fill="#ffa940"/>
                          <rect x="29" y="8" width="6" height="6" rx="3" fill="#ffa940"/>
                        </svg>
                        Tr·ª£ l√Ω Scratch
                    </span>
                </h2>
                <div class="chat-controls" role="toolbar" aria-label="Chat controls">
                    <button id="toggle-fullscreen-btn" class="icon-btn" title="To√†n m√†n h√¨nh" aria-pressed="false">‚§¢</button>
                    <button id="close-fullscreen-btn" class="icon-btn" title="ƒê√≥ng to√†n m√†n h√¨nh" aria-pressed="false" style="display:none">‚úï</button>
                </div>
            </div>
            <p>Xin ch√†o! M√¨nh l√† Mentor Scratch ‚Äî h·ªèi g√¨ c·ª© h·ªèi nh√©.</p>
            <div id="chat-window" class="chat-window" aria-live="polite">
                <div class="chat-message ai-message">
            Hi! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?
                </div>
            </div>
            <div id="attachment-preview" class="attachment-preview" aria-hidden="true" style="display:none"></div>
            <div class="chat-input-area" role="form" aria-label="G·ª≠i tin nh·∫Øn">
                <label for="file-input" class="icon-btn" title="ƒê√≠nh k√®m t·ªáp">üìé</label>
                <input type="file" id="file-input" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/zip,.sb3" multiple style="display:none" aria-label="Ch·ªçn t·ªáp ƒë√≠nh k√®m" capture="environment">
                <input type="text" id="user-input" placeholder="ƒê·∫∑t c√¢u h·ªèi b·∫•t k·ª≥..." autocomplete="off" aria-label="N·ªôi dung c√¢u h·ªèi">
                <button id="send-button" class="send-btn">G·ª≠i</button>
            </div>
        </section>
    </div>

    <footer class="site-footer" aria-hidden="false">
        </footer>

    <a href="#page-top" id="back-to-top-btn" title="L√™n ƒë·∫ßu trang" style="display:none;">‚¨ÜÔ∏è</a>


    <script>
    // --- C√ÅC H√ÄM QU·∫¢N L√ù ƒê√çNH K√àM ƒê∆Ø·ª¢C ƒê∆ØA RA NGO√ÄI (GLOBAL) ---
    // ƒê·ªÉ cho chatbot.js c√≥ th·ªÉ truy c·∫≠p v√† d·ªçn d·∫πp

    // Store attachments in-memory for UI; chatbot.js s·∫Ω ƒë·ªçc m·∫£ng n√†y
    window.attachments = []; // each item: { file, url, id }
    
    /**
     * Hi·ªÉn th·ªã c√°c t·ªáp ƒë√≠nh k√®m trong khu v·ª±c preview
     */
    window.renderAttachments = function(progressText) {
        const previewArea = document.getElementById('attachment-preview');
        if (!previewArea) return;

        previewArea.innerHTML = '';
        if (window.attachments.length === 0) {
            previewArea.style.display = 'none';
            previewArea.setAttribute('aria-hidden','true');
            return;
        }
        previewArea.style.display = 'flex';
        previewArea.setAttribute('aria-hidden','false');

        window.attachments.forEach(att => {
            const item = document.createElement('div');
            item.className = 'attachment-item';
            item.setAttribute('data-id', att.id);

            if (att.file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.className = 'attachment-thumb';
                img.src = att.url;
                img.alt = att.file.name;
                img.title = att.file.name;
                item.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'attachment-thumb';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.fontSize = '0.9rem';
                placeholder.textContent = 'üìÑ'; // Bi·ªÉu t∆∞·ª£ng t·ªáp
                item.appendChild(placeholder);
            }

            const meta = document.createElement('div');
            meta.className = 'attachment-meta';
            const name = document.createElement('div');
            name.textContent = att.file.name;
            const size = document.createElement('div');
            size.style.fontSize = '0.78rem';
            size.style.color = 'var(--muted)';
            size.textContent = (att.file.size < 1024*1024) ? (Math.round(att.file.size/1024)+' KB') : (Math.round(att.file.size/(1024*1024))+' MB');
            meta.appendChild(name);
            meta.appendChild(size);
            item.appendChild(meta);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'attachment-remove';
            removeBtn.title = 'X√≥a';
            removeBtn.innerHTML = '‚úï';
            removeBtn.addEventListener('click', () => {
                window.removeAttachment(att.id); // G·ªçi h√†m global
            });
            item.appendChild(removeBtn);

            previewArea.appendChild(item);
        });

        if (progressText) {
            const prog = document.createElement('div');
            prog.className = 'upload-progress';
            prog.textContent = progressText;
            previewArea.appendChild(prog);
        }
    }

    /**
     * X√≥a m·ªôt t·ªáp ƒë√≠nh k√®m kh·ªèi m·∫£ng global
     */
    window.removeAttachment = function(id) {
        const idx = window.attachments.findIndex(a => a.id === id);
        if (idx !== -1) {
            const a = window.attachments[idx];
            if (a.url && a.file.type.startsWith('image/')) {
                URL.revokeObjectURL(a.url); // Thu h·ªìi blob URL
            }
            window.attachments.splice(idx,1);
            window.renderAttachments(); // C·∫≠p nh·∫≠t l·∫°i UI
        }
    }

    /**
     * Th√™m c√°c t·ªáp ƒë∆∞·ª£c ch·ªçn v√†o m·∫£ng global
     */
    window.addFiles = function(fileList) {
        const maxFiles = 8;
        const maxSizePerFile = 25 * 1024 * 1024; // 25MB per file
        for (let i=0;i<fileList.length;i++) {
            if (window.attachments.length >= maxFiles) break;
            const f = fileList[i];
            if (f.size > maxSizePerFile) {
                alert('T·ªáp "'+f.name+'" qu√° l·ªõn (t·ªëi ƒëa 25MB).');
                continue;
            }
            const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
            const att = { id, file: f, url: null };
            if (f.type.startsWith('image/')) {
                att.url = URL.createObjectURL(f); // T·∫°o blob URL ƒë·ªÉ xem tr∆∞·ªõc
            }
            window.attachments.push(att);
        }
        window.renderAttachments(); // C·∫≠p nh·∫≠t UI
    }
    
    /**
     * H√†m tr·ª£ gi√∫p (global) ƒë·ªÉ chatbot.js t·∫°o tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
     * (H√†m n√†y ƒë√£ c√≥ trong t·ªáp g·ªëc c·ªßa b·∫°n, ch·ªâ c·∫ßn ƒë∆∞a ra global)
     */
    window.appendUserMessage = function(text, imageUrls, fileLinks) {
        const chatWindow = document.getElementById('chat-window');
        if (!chatWindow) return;

        const userMsg = document.createElement('div');
        userMsg.className = 'chat-message user-message';
        
        // Ch·ªâ th√™m vƒÉn b·∫£n n·∫øu c√≥
        if (text) {
            const textNode = document.createTextNode(text);
            userMsg.appendChild(textNode);
        }

        if ((imageUrls && imageUrls.length) || (fileLinks && fileLinks.length)) {
            const wrapper = document.createElement('div');
            wrapper.style.marginTop = '8px';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.gap = '6px';

            (imageUrls || []).forEach(url => {
                const a = document.createElement('a');
                a.href = url; // blob:http...
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'image preview';
                img.style.maxWidth = '220px';
                img.style.borderRadius = '8px';
                img.style.display = 'block';
                a.appendChild(img);
                wrapper.appendChild(a);
            });

            (fileLinks || []).forEach(link => {
                const fileLink = document.createElement('a');
                fileLink.href = link.url; // S·∫Ω l√† '#' n·∫øu kh√¥ng ph·∫£i ·∫£nh
                fileLink.target = '_blank';
                fileLink.rel = 'noopener noreferrer';
                fileLink.textContent = 'T·ªáp: ' + link.name;
                fileLink.style.color = '#fff';
                fileLink.style.textDecoration = 'underline';
                wrapper.appendChild(fileLink);
            });

            userMsg.appendChild(wrapper);
        }

        chatWindow.appendChild(userMsg);
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
    }


    // --- SCRIPT QU·∫¢N L√ù GIAO DI·ªÜN CHUNG (Gi·ªØ nguy√™n) ---
    document.addEventListener('DOMContentLoaded', function() {
        const backToTopBtn = document.getElementById("back-to-top-btn");
        window.onscroll = () => {
            if(backToTopBtn) backToTopBtn.style.display = (document.body.scrollTop > 140 || document.documentElement.scrollTop > 140) ? "block" : "none";
        };

        // Fullscreen (Gi·ªØ nguy√™n)
        const chatCard = document.getElementById('ai-chatbot-card');
        const toggleBtn = document.getElementById('toggle-fullscreen-btn');
        const closeBtn = document.getElementById('close-fullscreen-btn');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-button');

        function openFullscreenMode() {
            chatCard.classList.add('chat-fullscreen');
            toggleBtn.setAttribute('aria-pressed','true');
            toggleBtn.style.display = 'none';
            closeBtn.style.display = 'inline-block';
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            userInput.focus();
        }
        function closeFullscreenMode() {
            chatCard.classList.remove('chat-fullscreen');
            toggleBtn.setAttribute('aria-pressed','false');
            toggleBtn.style.display = 'inline-block';
            closeBtn.style.display = 'none';
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
        }
        if(toggleBtn) toggleBtn.addEventListener('click', openFullscreenMode);
        if(closeBtn) closeBtn.addEventListener('click', closeFullscreenMode);

        // Enter-to-send (Gi·ªØ nguy√™n - chatbot.js c≈©ng x·ª≠ l√Ω vi·ªác n√†y, nh∆∞ng ƒë·ªÉ ƒë√¢y kh√¥ng sao)
        if(userInput) userInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                // chatbot.js s·∫Ω x·ª≠ l√Ω click
                if(sendBtn) sendBtn.click();
            }
        });

        // Smart auto-scroll (Gi·ªØ nguy√™n)
        if(chatWindow) {
            const observer = new MutationObserver(() => {
                const nearBottomThreshold = 120;
                const distanceFromBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight;
                const shouldAutoScroll = distanceFromBottom < nearBottomThreshold;
                if (shouldAutoScroll) {
                    chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
                }
            });
            observer.observe(chatWindow, { childList:true, subtree:true });
            chatWindow.style.webkitOverflowScrolling = 'touch';
        }

        // --- Attachment handling (Ch·ªâ gi·ªØ l·∫°i ph·∫ßn l·∫Øng nghe s·ª± ki·ªán) ---
        const fileInput = document.getElementById('file-input');
        
        if(fileInput) fileInput.addEventListener('change', function(e){
            if (!e.target.files) return;
            window.addFiles(e.target.files); // G·ªçi h√†m global
            fileInput.value = ''; // X√≥a ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i
        });

        // Drag & drop support (Gi·ªØ nguy√™n)
        const dropTarget = chatCard;
        if(dropTarget) {
            dropTarget.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
            dropTarget.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.dataTransfer && e.dataTransfer.files) {
                    window.addFiles(e.dataTransfer.files); // G·ªçi h√†m global
                }
            });
        }
        
        // [ƒê√É X√ìA] sendBtn.addEventListener('click', ...)
        // [ƒê√É X√ìA] uploadAttachmentsWithProgress(...)
        // To√†n b·ªô logic g·ª≠i v√† t·∫£i l√™n ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang chatbot.js
    });
    </script>

    <script src="../shared/chatbot.js"></script>
</body>
</html>
